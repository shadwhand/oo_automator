{% extends "base.html" %}

{% block title %}{{ test.name or "Test" }} - OO Automator{% endblock %}

{% block content %}
<div class="page-header">
    <a href="/" class="back-link">&larr; Back to Dashboard</a>
    <div class="test-name-container">
        <h1 class="test-name-display" id="test-name-display" onclick="startEditName()">
            {{ test.name or "(Click to name this test)" }}
            <span class="edit-hint">click to edit</span>
        </h1>
        <div class="test-name-edit" id="test-name-edit" style="display: none;">
            <input type="text" id="test-name-input" value="{{ test.name or '' }}" placeholder="Enter test name...">
            <button onclick="saveName()" class="btn btn-primary btn-sm">Save</button>
            <button onclick="cancelEditName()" class="btn btn-secondary btn-sm">Cancel</button>
        </div>
    </div>
</div>

<section class="test-info-section">
    <div class="test-details">
        <div class="detail-item">
            <label>Test URL</label>
            <a href="{{ test.url }}" target="_blank" class="test-url-link">{{ test.url }}</a>
        </div>
        <div class="detail-row">
            <div class="detail-item">
                <label>Total Runs</label>
                <span class="value">{{ test.run_count }}</span>
            </div>
            <div class="detail-item">
                <label>Created</label>
                <span class="value local-time" data-utc="{{ test.created_at.isoformat() if test.created_at else '' }}">
                    {{ test.created_at.strftime('%Y-%m-%d %H:%M') if test.created_at else 'N/A' }}
                </span>
            </div>
            <div class="detail-item">
                <label>Last Run</label>
                <span class="value local-time" data-utc="{{ test.last_run_at.isoformat() if test.last_run_at else '' }}">
                    {{ test.last_run_at.strftime('%Y-%m-%d %H:%M') if test.last_run_at else 'Never' }}
                </span>
            </div>
        </div>
    </div>
    <div class="test-actions">
        <a href="/new-run?test_id={{ test.id }}" class="btn btn-primary">+ New Run for This Test</a>
    </div>
</section>

<section class="runs-section">
    <h2>All Runs ({{ runs|length }})</h2>
    {% if runs %}
    <table class="runs-table">
        <thead>
            <tr>
                <th>Run ID</th>
                <th>Mode</th>
                <th>Status</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for run in runs %}
            <tr class="run-row">
                <td><a href="/runs/{{ run.id }}">#{{ run.id }}</a></td>
                <td><span class="badge">{{ run.mode }}</span></td>
                <td><span class="status-badge status-{{ run.status }}">{{ run.status }}</span></td>
                <td class="local-time" data-utc="{{ run.created_at.isoformat() if run.created_at else '' }}">
                    {{ run.created_at.strftime('%Y-%m-%d %H:%M') if run.created_at else 'N/A' }}
                </td>
                <td class="actions-cell">
                    <a href="/runs/{{ run.id }}" class="btn btn-small">View</a>
                    {% if run.status == 'completed' %}
                    <a href="/runs/{{ run.id }}/results" class="btn btn-small btn-secondary">Results</a>
                    <a href="/runs/{{ run.id }}/recommendations" class="btn btn-small btn-accent">Recommendations</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty-state">No runs yet for this test.</p>
    {% endif %}
</section>

<style>
.test-name-container {
    position: relative;
}

.test-name-display {
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.test-name-display:hover {
    color: var(--primary);
}

.edit-hint {
    font-size: 0.7rem;
    color: var(--text-muted, #6c757d);
    font-weight: normal;
    opacity: 0;
    transition: opacity 0.2s;
}

.test-name-display:hover .edit-hint {
    opacity: 1;
}

.test-name-edit {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.test-name-edit input {
    font-size: 1.5rem;
    padding: 0.5rem;
    border: 2px solid var(--primary);
    border-radius: 4px;
    background: var(--surface);
    color: var(--text);
    min-width: 300px;
}

.test-info-section {
    background: var(--surface);
    padding: 24px;
    border-radius: 8px;
    margin-bottom: 24px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 24px;
}

.test-details {
    flex: 1;
}

.detail-item {
    margin-bottom: 16px;
}

.detail-item label {
    display: block;
    font-size: 0.75rem;
    color: var(--text-secondary);
    margin-bottom: 4px;
    text-transform: uppercase;
}

.detail-item .value {
    font-size: 1.1rem;
}

.test-url-link {
    color: var(--primary);
    word-break: break-all;
}

.detail-row {
    display: flex;
    gap: 32px;
}

.runs-table {
    width: 100%;
    border-collapse: collapse;
}

.runs-table th,
.runs-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid var(--border);
}

.runs-table th {
    font-weight: 600;
    color: var(--text-secondary);
    font-size: 0.875rem;
}

.runs-table a {
    color: var(--primary);
    text-decoration: none;
}

.runs-table a:hover {
    text-decoration: underline;
}

.actions-cell {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.btn-small {
    padding: 4px 12px;
    font-size: 0.875rem;
}

.btn-accent {
    background: var(--accent, #8b5cf6);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    text-decoration: none;
}

.btn-accent:hover {
    background: var(--accent-hover, #7c3aed);
}

.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
}

.status-pending {
    background: var(--warning-bg, #fef3c7);
    color: var(--warning-text, #92400e);
}

.status-running {
    background: var(--info-bg, #dbeafe);
    color: var(--info-text, #1e40af);
}

.status-completed {
    background: var(--success-bg, #d1fae5);
    color: var(--success-text, #065f46);
}

.status-failed, .status-stopped {
    background: var(--error-bg, #fee2e2);
    color: var(--error-text, #991b1b);
}
</style>

<script>
const testId = {{ test.id }};

function startEditName() {
    document.getElementById('test-name-display').style.display = 'none';
    document.getElementById('test-name-edit').style.display = 'flex';
    document.getElementById('test-name-input').focus();
    document.getElementById('test-name-input').select();
}

function cancelEditName() {
    document.getElementById('test-name-edit').style.display = 'none';
    document.getElementById('test-name-display').style.display = 'inline-flex';
}

async function saveName() {
    const input = document.getElementById('test-name-input');
    const newName = input.value.trim();

    try {
        const response = await fetch(`/api/tests/${testId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName })
        });

        if (!response.ok) {
            throw new Error('Failed to save name');
        }

        const data = await response.json();
        const display = document.getElementById('test-name-display');
        display.innerHTML = (data.name || '(Click to name this test)') + '<span class="edit-hint">click to edit</span>';
        cancelEditName();
    } catch (error) {
        alert('Failed to save name: ' + error.message);
    }
}

// Handle Enter key in input
document.getElementById('test-name-input').addEventListener('keydown', function(e) {
    if (e.key === 'Enter') {
        saveName();
    } else if (e.key === 'Escape') {
        cancelEditName();
    }
});

// Convert UTC timestamps to local time
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.local-time').forEach(function(el) {
        const utc = el.dataset.utc;
        if (utc) {
            const date = new Date(utc + 'Z'); // Append Z to indicate UTC
            if (!isNaN(date.getTime())) {
                el.textContent = date.toLocaleString(undefined, {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }
    });
});
</script>
{% endblock %}
